<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marcador de Casas</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --ink:#0f1a2a;
      --muted:#5f6b85;
      --ring:#e4e8f2;
      --brand:#B3002D;
      --brand2:#D0312D;
      --shadow: 0 14px 32px rgba(16,30,60,.10);
      --shadow2: 0 10px 24px rgba(16,30,60,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(179,0,45,.10) 0%, rgba(179,0,45,0) 60%),
        radial-gradient(1000px 500px at 110% 10%, rgba(208,49,45,.10) 0%, rgba(208,49,45,0) 60%),
        var(--bg);
    }
    .wrap{max-width:1260px;margin:0 auto;padding:22px 12px 34px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex;gap:12px;align-items:center;
      background:linear-gradient(180deg,#fff,#fff7f9);
      border:1px solid var(--ring);
      border-radius:16px;
      padding:10px 14px;
      box-shadow:var(--shadow2);
      min-width:min(640px,100%);
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px;color:var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .pill{
      background:#fff;border:1px solid var(--ring);border-radius:999px;
      padding:6px 10px;font-size:12px;color:var(--muted);
      box-shadow:0 6px 16px rgba(16,30,60,.06);
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(320px, 1fr));
      gap:26px;
      align-items:start;
      margin-top:18px;
    }
    @media (max-width:720px){
      .grid{grid-template-columns:1fr;gap:16px}
    }

    .card{
      position:relative;
      background:var(--panel);
      border:1px solid var(--ring);
      border-radius:var(--r);
      padding:16px 16px 14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .badge{
      position:absolute;top:12px;right:12px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#fff;
      font-weight:900;font-size:14px;z-index:2;
    }
    .b1{background:linear-gradient(180deg,#fff7d1,#fde68a);color:#7a5a00;border-color:#f1ce55}
    .b2{background:linear-gradient(180deg,#f5f7fb,#e7eaf2);color:#4b5563;border-color:#d5dae6}
    .b3{background:linear-gradient(180deg,#fff1df,#fde3c7);color:#7a4a1a;border-color:#f0c9a1}

    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;min-width:0}
    .id{display:flex;align-items:center;gap:12px;min-width:0}
    .avatar{
      width:62px;height:62px;border-radius:14px;
      background:#f3f6fc;border:1px dashed #cbd5e1;
      overflow:hidden;flex:0 0 auto;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .name{
      font-weight:900;font-size:18px;min-width:0;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .total{
      font-weight:900;font-size:30px;white-space:nowrap;flex:0 0 auto;
      letter-spacing:.2px;
    }

    .progress{
      margin-top:10px;height:12px;border-radius:999px;
      border:1px solid var(--ring);background:#f3f6fc;overflow:hidden;
    }
    .bar{
      height:100%;width:0;
      transition: width .9s cubic-bezier(.2,.8,.2,1);
    }

    details{margin-top:12px;border-top:1px dashed var(--ring);padding-top:10px}
    summary{
      cursor:pointer;font-weight:800;color:var(--muted);
      list-style:none;user-select:none;
    }
    summary::-webkit-details-marker{display:none}

    .sectionTitle{
      margin:10px 0 6px;font-weight:900;font-size:12px;color:var(--muted);
      text-transform:uppercase;letter-spacing:.08em;
    }

    .subgrid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    .row{
      display:grid;
      grid-template-columns:minmax(140px,1fr) minmax(110px,2fr) auto;
      gap:10px;align-items:center;
      font-size:13px;color:#334155;min-width:0;
    }
    .row>span{min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini{height:6px;border-radius:999px;border:1px solid var(--ring);background:#f3f6fc;overflow:hidden}
    .mini>b{display:block;height:100%;width:0}
    .row strong{justify-self:end;white-space:nowrap}

    .students{display:flex;flex-direction:column;gap:6px}
    .student{
      display:grid;grid-template-columns:1fr auto;
      gap:10px;align-items:center;
      border:1px solid var(--ring);border-radius:12px;padding:8px 10px;background:#fff;min-width:0;
    }
    .student .sn{min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:800}
    .student .st{white-space:nowrap;font-weight:900}

    .feed{display:flex;flex-direction:column;gap:8px}
    .event{
      border:1px solid var(--ring);border-radius:12px;padding:10px;background:#fff;
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;
    }
    .event .who{font-weight:900}
    .event .why{color:#334155;font-size:13px;margin-top:2px;overflow:hidden;text-overflow:ellipsis}
    .event .meta{color:var(--muted);font-size:12px;white-space:nowrap;text-align:right}
    .event .pts{font-weight:900;font-size:14px}

    .footer{
      margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:10px;
      flex-wrap:wrap;color:var(--muted);font-size:12px;
    }

    .errorBox{
      border:1px solid rgba(179,0,45,.35);
      background:rgba(179,0,45,.06);
      color:#5b1222;
      border-radius:14px;
      padding:12px 14px;
      box-shadow:0 10px 24px rgba(16,30,60,.06);
      margin-top:14px;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand" aria-label="Marcador público">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 3h12a2 2 0 0 1 2 2v16l-8-4-8 4V5a2 2 0 0 1 2-2z" stroke="var(--brand)" stroke-width="1.5"/>
        </svg>
        <div style="min-width:0">
          <h1 id="boardTitle">Marcador de Casas</h1>
          <div class="muted" id="subTitle">Actualizando…</div>
        </div>
      </div>
      <span class="pill" id="status">Cargando…</span>
    </header>

    <div class="errorBox" id="errBox"></div>

    <section class="grid" id="grid" aria-live="polite"></section>

    <div class="footer">
      <span id="updated">Sin datos todavía.</span>
      <span>© Curso actual — lectura</span>
    </div>
  </div>

<script>
(() => {
  /**
   * Pega aquí el ID de tu Google Sheet (lo que hay entre /d/ y /edit)
   * El Sheet debe estar compartido como: "Cualquiera con el enlace: Lector"
   */
  const SHEET_ID = "1Y54iUggeHpVMc94KpiE0x5mmRdq8AUSMrCq03Ku6YkQ";

  const TAB_TEAMS = "TEAMS";
  const TAB_TEAM_TOTALS = "TOTALS_TEAM";
  const TAB_STUDENT_TOTALS = "TOTALS_STUDENT";
  const TAB_FEED = "FEED";

  const REFRESH_SECONDS = 15;

  const grid = document.getElementById('grid');
  const titleEl = document.getElementById('boardTitle');
  const subEl = document.getElementById('subTitle');
  const statusEl = document.getElementById('status');
  const updatedEl = document.getElementById('updated');
  const errBox = document.getElementById('errBox');

  const num = v => {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  };
  const stripe = c => `repeating-linear-gradient(45deg, ${c}, ${c} 8px, rgba(255,255,255,.10) 8px, rgba(255,255,255,.10) 16px)`;
  const safe = s => String(s ?? "").trim();
  const safeHex = c => safe(c) || "#B3002D";

  function gvizUrl(tab){
    const base = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq`;
    return `${base}?tqx=out:json&headers=1&sheet=${encodeURIComponent(tab)}`;
  }
  function parseGviz(text){
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    const json = JSON.parse(text.slice(start, end+1));
    const table = json.table || {};
    const cols = (table.cols || []).map(c => (c.label || "").trim());
    return (table.rows || []).map(r => {
      const obj = {};
      (r.c || []).forEach((cell, i) => {
        const key = cols[i] || `col_${i}`;
        obj[key] = (cell && cell.v != null) ? cell.v : "";
      });
      return obj;
    });
  }
  async function fetchTab(tab){
    const res = await fetch(gvizUrl(tab), { cache: "no-store" });
    if(!res.ok) throw new Error(`No se pudo leer "${tab}" (HTTP ${res.status}).`);
    return parseGviz(await res.text());
  }

  function normalizeTeams(rows){
    return rows.map(r => ({
      id: safe(r.team_id || r.team || r.Equipo || r.teamId),
      name: safe(r.Nombre || r.team_name || r.nombre || r.Name || r.team),
      color: safeHex(r.Color || r.team_color_hex || r.color),
      image: safe(r.Imagen_URL || r.image_url || r.imagen || r.image)
    })).filter(t => t.id);
  }

  function categoriesFromTeamTotals(teamTotalsRows){
    const keys = Object.keys(teamTotalsRows[0] || {});
    return keys.filter(k => !["Equipo","TOTAL","team_id","team"].includes(k));
  }

  function buildModel(teamsRows, teamTotalsRows, studentTotalsRows, feedRows){
    const teams = normalizeTeams(teamsRows);
    const categories = categoriesFromTeamTotals(teamTotalsRows);

    const teamTotals = new Map();
    for(const r of teamTotalsRows){
      const tid = safe(r.Equipo || r.team_id || r.team);
      if(!tid) continue;
      const byCat = {};
      categories.forEach(c => byCat[c] = num(r[c]));
      const total = num(r.TOTAL);
      teamTotals.set(tid, { byCat, total });
    }

    const studentsByTeam = new Map(teams.map(t => [t.id, []]));
    for(const r of studentTotalsRows){
      const tid = safe(r.Equipo || r.team_id || r.team);
      if(!studentsByTeam.has(tid)) continue;

      const perCat = {};
      categories.forEach(c => perCat[c] = num(r[c]));
      const total = num(r.TOTAL);
      studentsByTeam.get(tid).push({
        id: safe(r.student_id || r.id),
        name: safe(r.Alumno || r.student_name || r.alumno || r.name || r.Nombre),
        total, perCat
      });
    }
    for(const [tid, arr] of studentsByTeam) arr.sort((a,b)=>b.total-a.total);

    const feedByTeam = new Map(teams.map(t => [t.id, []]));
    for(const r of feedRows){
      const tid = safe(r.equipo || r.Equipo || r.team_id || r.team);
      if(!feedByTeam.has(tid)) continue;
      feedByTeam.get(tid).push({
        ts: safe(r.timestamp_iso || r.ts || r.timestamp),
        date: safe(r.fecha || r.date),
        subject: safe(r.asignatura || r.subject),
        student: safe(r.alumno || r.student_name || r.student),
        category: safe(r.categoria || r.category),
        delta: num(r.delta),
        entry: safe(r.entrada || r.entry)
      });
    }
    for(const [tid, arr] of feedByTeam){
      arr.sort((a,b)=> (b.ts||"").localeCompare(a.ts||""));
    }

    const teamModels = teams.map(t => {
      const tt = teamTotals.get(t.id) || { byCat: Object.fromEntries(categories.map(c=>[c,0])), total: 0 };
      const members = studentsByTeam.get(t.id) || [];
      const feed = (feedByTeam.get(t.id) || []).slice(0, 10);
      return {
        id: t.id,
        name: t.name || t.id,
        color: t.color,
        image: t.image,
        categories,
        byCat: tt.byCat,
        total: tt.total,
        members,
        feed
      };
    }).sort((a,b)=>b.total-a.total);

    return { teams: teamModels, categories };
  }

  function render(model){
    grid.innerHTML = "";
    const maxTotal = Math.max(1, ...model.teams.map(t=>t.total));

    model.teams.forEach((t, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `#${idx+1}`;
      if(idx===0) badge.classList.add("b1");
      else if(idx===1) badge.classList.add("b2");
      else if(idx===2) badge.classList.add("b3");
      card.appendChild(badge);

      const top = document.createElement("div"); top.className = "top";
      const id = document.createElement("div"); id.className = "id";

      const av = document.createElement("div"); av.className = "avatar";
      if(t.image){
        const im = document.createElement("img");
        im.src = t.image;
        im.alt = `Imagen de ${t.name}`;
        av.appendChild(im);
      }
      const name = document.createElement("div"); name.className = "name";
      name.textContent = t.name;
      name.style.color = t.color;

      id.appendChild(av);
      id.appendChild(name);

      const total = document.createElement("div"); total.className = "total";
      total.textContent = t.total;
      total.style.color = t.color;

      top.appendChild(id);
      top.appendChild(total);
      card.appendChild(top);

      const prog = document.createElement("div"); prog.className = "progress";
      const bar = document.createElement("div"); bar.className = "bar";
      bar.style.background = stripe(t.color);
      requestAnimationFrame(()=>{ bar.style.width = `${(t.total/maxTotal)*100}%`; });
      prog.appendChild(bar);
      card.appendChild(prog);

      const details = document.createElement("details");
      const summary = document.createElement("summary");
      summary.textContent = "Ver desglose (categorías, alumnos y últimos puntos)";
      details.appendChild(summary);

      const catTitle = document.createElement("div");
      catTitle.className = "sectionTitle";
      catTitle.textContent = "Categorías";
      details.appendChild(catTitle);

      const catBox = document.createElement("div"); catBox.className = "subgrid";
      const maxCat = Math.max(1, ...Object.values(t.byCat || {}));
      Object.entries(t.byCat || {}).forEach(([c,v])=>{
        const row = document.createElement("div"); row.className="row";
        const lab = document.createElement("span"); lab.textContent = c; lab.title = c;
        const mini = document.createElement("div"); mini.className="mini";
        const b = document.createElement("b");
        b.style.background = t.color;
        b.style.width = `${(num(v)/maxCat)*100}%`;
        mini.appendChild(b);
        const val = document.createElement("strong"); val.textContent = v;
        row.appendChild(lab); row.appendChild(mini); row.appendChild(val);
        catBox.appendChild(row);
      });
      details.appendChild(catBox);

      const stuTitle = document.createElement("div");
      stuTitle.className = "sectionTitle";
      stuTitle.textContent = "Alumnos";
      details.appendChild(stuTitle);

      const stu = document.createElement("div"); stu.className="students";
      (t.members || []).forEach(m=>{
        const s = document.createElement("div"); s.className="student";
        const sn = document.createElement("div"); sn.className="sn"; sn.textContent = m.name || m.id;
        const st = document.createElement("div"); st.className="st"; st.textContent = m.total;
        s.appendChild(sn); s.appendChild(st);
        stu.appendChild(s);
      });
      details.appendChild(stu);

      const feedTitle = document.createElement("div");
      feedTitle.className = "sectionTitle";
      feedTitle.textContent = "Últimos puntos (motivos)";
      details.appendChild(feedTitle);

      const feed = document.createElement("div"); feed.className="feed";
      if((t.feed || []).length){
        (t.feed || []).forEach(e=>{
          const ev = document.createElement("div"); ev.className="event";

          const txt = document.createElement("div");
          const who = document.createElement("div"); who.className="who";
          who.textContent = `${e.student || "Alumno"} · ${e.subject || ""} · ${e.category || ""}`.replace(/\s·\s·/g," · ").replace(/\s·\s$/,"");
          const why = document.createElement("div"); why.className="why";
          why.textContent = e.entry || (e.date ? `${e.date} — ${e.subject}: ${(e.delta>=0?"+":"")}${e.delta} en ${e.category}` : "");
          txt.appendChild(who);
          txt.appendChild(why);

          const meta = document.createElement("div"); meta.className="meta";
          const pts = document.createElement("div"); pts.className="pts"; pts.style.color = t.color;
          pts.textContent = (e.delta>=0 ? `+${e.delta}` : `${e.delta}`);
          const when = document.createElement("div"); when.textContent = e.date || "";
          meta.appendChild(pts);
          meta.appendChild(when);

          ev.appendChild(txt);
          ev.appendChild(meta);

          feed.appendChild(ev);
        });
      }else{
        const none = document.createElement("div");
        none.className = "muted";
        none.textContent = "Aún no hay eventos registrados.";
        feed.appendChild(none);
      }
      details.appendChild(feed);

      card.appendChild(details);
      grid.appendChild(card);
    });

    updatedEl.textContent = "Última actualización: " + new Date().toLocaleString();
  }

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearError(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  let timer = null;
  async function loadAll(showStatus){
    if(showStatus) statusEl.textContent = "Cargando…";
    clearError();

    try{
      const [teamsRows, teamTotalsRows, studentTotalsRows, feedRows] = await Promise.all([
        fetchTab(TAB_TEAMS),
        fetchTab(TAB_TEAM_TOTALS),
        fetchTab(TAB_STUDENT_TOTALS),
        fetchTab(TAB_FEED)
      ]);

      const model = buildModel(teamsRows, teamTotalsRows, studentTotalsRows, feedRows);

      titleEl.textContent = "Marcador de Casas";
      subEl.textContent = `Auto‑refresco cada ${REFRESH_SECONDS}s · Equipos: 2 arriba / 2 abajo`;

      render(model);
      statusEl.textContent = "OK";

      clearInterval(timer);
      timer = setInterval(() => loadAll(false), REFRESH_SECONDS * 1000);
    }catch(err){
      console.error(err);
      statusEl.textContent = "Error";
      showError(
        "No se pudo cargar el marcador.\n\n" +
        "Checklist:\n" +
        "1) Has pegado tu SHEET_ID en el HTML.\n" +
        "2) El Google Sheet está compartido como: Cualquiera con el enlace → Lector.\n" +
        "3) Existen las pestañas: TEAMS, TOTALS_TEAM, TOTALS_STUDENT y FEED.\n\n" +
        "Detalle técnico: " + (err && err.message ? err.message : String(err))
      );
    }
  }

  loadAll(true);
})();
</script>
</body>
</html>
